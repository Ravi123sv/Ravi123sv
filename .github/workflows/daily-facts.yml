name: Daily Fact Update via API

on:
  schedule:
    - cron: '0 0 * * *'  # Runs daily at 00:00 UTC
  workflow_dispatch:

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y jq curl

      - name: Fetch Daily Fact
        id: fact
        run: |
          FACT=$(curl -s https://uselessfacts.jsph.pl/api/v2/facts/random?language=en | jq -r '.text')
          echo "FACT=$FACT" >> $GITHUB_ENV

      - name: Get README SHA
        id: readmesha
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          SHA=$(curl -s -H "Authorization: token $GH_PAT" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/Ravi123sv/Ravi123sv/contents/README.md \
            | jq -r '.sha')
          echo "SHA=$SHA" >> $GITHUB_ENV

      - name: Update README via API
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          FACT: ${{ env.FACT }}
          SHA: ${{ env.SHA }}
        run: |
          NEW_CONTENT=$(curl -s https://raw.githubusercontent.com/Ravi123sv/Ravi123sv/main/README.md \
            | awk -v fact="$FACT" '/### ðŸŒŸ Daily Fact/{print;getline;print "> _"fact"_";next}1' \
            | base64 | tr -d '\n')

curl -X PUT -H "Authorization: token $GH_PAT" \
  -H "Accept: application/vnd.github.v3+json" \
  https://api.github.com/repos/Ravi123sv/Ravi123sv/contents/README.md \
  -d @- <<EOF
{
  "message": "Update daily fact",
  "content": "$NEW_CONTENT",
  "sha": "$SHA"
}
EOF
